<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PSX Emulator - Psychology Project</title>
    <style>
        body { background-color: #000; color: #fff; margin: 0; padding: 0; font-family: sans-serif; text-align: center; }
        canvas { width: 100%; max-width: 800px; border: 2px solid #222; background: #111; margin-top: 10px; }
        .menu-bar { background: #1a1a1a; padding: 20px; border-top: 2px solid #333; margin-top: 10px; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 24px; margin: 5px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-save { background: #28a745; }
        #status { color: #00ff00; margin-bottom: 10px; font-size: 14px; font-weight: bold; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

    <div class="menu-bar">
        <div id="status">Engine Status: Waiting...</div>

        <button class="btn" onclick="document.getElementById('file-input').click()">SELECT .BIN GAME</button>
        <input type="file" id="file-input" accept=".bin" onchange="bootGame(this)">

        <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">

        <button class="btn btn-save" onclick="exportSave()">DOWNLOAD SAVE</button>
        <button class="btn" style="background:#555" onclick="document.getElementById('save-input').click()">UPLOAD SAVE</button>
        <input type="file" id="save-input" onchange="importSave(this)">
    </div>

    <script>
        function injectEngine() {
            var script = document.createElement('script');
            // Using external source to bypass GitHub timeout errors
            script.src = "https://lrusso.github.io/VirtualPlayStation/PlayStation.js";
            document.head.appendChild(script);
        }

        window.onload = function() {
            alert("Page loaded. Attempting to start engine in 3 seconds...");
            setTimeout(injectEngine, 3000);
        };

        var Module = {
            canvas: document.getElementById('canvas'),
            onRuntimeInitialized: function() {
                alert("ENGINE SUCCESS!");
                document.getElementById('status').innerText = "Ready. Select your .BIN file.";
            }
        };

        function bootGame(input) {
            if (input.files && input.files[0]) {
                window.load(input.files[0]);
                document.getElementById('status').innerText = "Playing: " + input.files[0].name;
            }
        }

        async function exportSave() {
            const req = indexedDB.open("wasmemu_db");
            req.onsuccess = () => {
                const store = req.result.transaction("files").objectStore("files");
                const getReq = store.get("/home/web_user/.pcsx/memcards/card1.mcd");
                getReq.onsuccess = () => {
                    if (!getReq.result) return alert("No save data found yet.");
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(new Blob([getReq.result.contents]));
                    a.download = "psx_save.mcd";
                    a.click();
                };
            };
        }

        function importSave(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const req = indexedDB.open("wasmemu_db");
                req.onsuccess = () => {
                    req.result.transaction("files", "readwrite").objectStore("files").put({
                        contents: new Uint8Array(e.target.result),
                        timestamp: new Date()
                    }, "/home/web_user/.pcsx/memcards/card1.mcd");
                    alert("Save imported!");
                };
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
    </script>
</body>
</html>
