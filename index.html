<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychology Project - PSX Emulator</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        #container { width: 100vw; height: calc(100vh - 180px); display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { max-width: 100%; max-height: 100%; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .controls { position: fixed; bottom: 0; left: 0; width: 100%; height: 180px; background: #1a1a1a; border-top: 2px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .row { margin: 5px 0; }
        button { padding: 10px 15px; margin: 0 5px; cursor: pointer; border-radius: 5px; border: 1px solid #444; font-weight: bold; transition: 0.2s; }
        .btn-boot { background: #eee; color: #000; }
        .btn-boot:hover { background: #ccc; }
        .btn-save { background: #2e7d32; color: #fff; }
        .btn-load { background: #1565c0; color: #fff; }
        input[type="file"] { background: #333; color: #fff; padding: 5px; border-radius: 4px; border: 1px solid #444; }
        #status { color: #ff9800; font-size: 12px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="container">
        </div>

    <div class="controls">
        <div id="status">Waiting for files...</div>
        
        <div class="row">
            <input type="file" id="multiDiscInput" multiple>
        </div>

        <div class="row">
            <button class="btn-boot" onclick="boot(0)">BOOT DISC 1</button>
            <button class="btn-boot" onclick="boot(1)">BOOT DISC 2</button>
            <button class="btn-boot" onclick="boot(2)">BOOT DISC 3</button>
        </div>

        <div class="row" style="border-top: 1px solid #333; padding-top: 10px; margin-top: 5px;">
            <button class="btn-save" onclick="exportSave()">Download Save</button>
            <button class="btn-load" onclick="document.getElementById('saveFile').click()">Upload Save</button>
            <input type="file" id="saveFile" style="display:none" onchange="importSave(this)">
        </div>
    </div>

    <script src="PlayStation.js"></script>

    <script>
        // ENGINE CONFIGURATION
        var Module = {
            canvas: (function() {
                var c = document.createElement('canvas');
                document.getElementById('container').appendChild(c);
                return c;
            })(),
            onRuntimeInitialized: function() {
                document.getElementById('status').innerText = "Emulator Ready! Select files and Boot.";
                window.isReady = true;
            }
        };

        function boot(index) {
            const input = document.getElementById('multiDiscInput');
            if (!input.files || !input.files[index]) {
                alert("Please select your .cue and .bin files first!");
                return;
            }

            const file = input.files[index];
            document.getElementById('status').innerText = "Booting: " + file.name;

            // Search for the load function in the minified code
            const loader = window.load || (window.Module ? Module.load : null);

            if (typeof loader === 'function') {
                loader(file);
            } else {
                alert("Engine is still loading. Wait 10 seconds.");
            }
        }

        // MEMORY CARD SYSTEM (IndexedDB)
        async function exportSave() {
            const req = indexedDB.open("wasmemu_db");
            req.onsuccess = function() {
                const db = req.result;
                const transaction = db.transaction("files", "readonly");
                const store = transaction.objectStore("files");
                const getReq = store.get("/home/web_user/.pcsx/memcards/card1.mcd");
                
                getReq.onsuccess = function() {
                    if (!getReq.result) return alert("Save in-game first!");
                    const blob = new Blob([getReq.result.contents]);
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = "psx_save.mcd";
                    a.click();
                };
            };
        }

        function importSave(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const req = indexedDB.open("wasmemu_db");
                req.onsuccess = function() {
                    const db = req.result;
                    const transaction = db.transaction("files", "readwrite");
                    transaction.objectStore("files").put({
                        contents: new Uint8Array(e.target.result),
                        timestamp: new Date()
                    }, "/home/web_user/.pcsx/memcards/card1.mcd");
                    alert("Memory Card Imported! Restarting...");
                    location.reload();
                };
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
    </script>
</body>
</html>
