<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PSX Emulator - Psychology Project</title>
    <style>
        body { background-color: #000; color: #fff; margin: 0; padding: 0; font-family: sans-serif; text-align: center; }
        canvas { width: 100%; max-width: 800px; border: 2px solid #222; background: #111; margin-top: 10px; }
        .menu-bar { background: #1a1a1a; padding: 20px; border-top: 2px solid #333; margin-top: 10px; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 24px; margin: 5px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-save { background: #28a745; }
        #status { color: #888; margin-bottom: 10px; font-size: 14px; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

    <div class="menu-bar">
        <div id="status">Engine Status: Waiting...</div>

        <button class="btn" onclick="document.getElementById('file-input').click()">SELECT .BIN GAME</button>
        <input type="file" id="file-input" accept=".bin" onchange="bootGame(this)">

        <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">

        <button class="btn btn-save" onclick="exportSave()">DOWNLOAD SAVE (.MCD)</button>
        <button class="btn" style="background:#555" onclick="document.getElementById('save-input').click()">UPLOAD SAVE (.MCD)</button>
        <input type="file" id="save-input" onchange="importSave(this)">
    </div>

    <script src="PlayStation.js"></script>

    <script>
        var Module = {
            canvas: document.getElementById('canvas'),
            onRuntimeInitialized: function() {
                document.getElementById('status').innerText = "Engine Ready. Select your .BIN.";
                document.getElementById('status').style.color = "#00ff00";
            }
        };

        function bootGame(input) {
            if (input.files && input.files[0]) {
                window.load(input.files[0]);
                document.getElementById('status').innerText = "Playing: " + input.files[0].name;
            }
        }

        // The "Bridge" to the internal save file
        async function exportSave() {
            try {
                const req = indexedDB.open("wasmemu_db");
                req.onsuccess = () => {
                    const db = req.result;
                    const transaction = db.transaction("files", "readonly");
                    const store = transaction.objectStore("files");
                    const getReq = store.get("/home/web_user/.pcsx/memcards/card1.mcd");
                    
                    getReq.onsuccess = () => {
                        if (!getReq.result) return alert("No save found! Did you save in-game yet?");
                        const blob = new Blob([getReq.result.contents]);
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = "psx_save.mcd";
                        a.click();
                    };
                };
            } catch (e) { alert("Error exporting: " + e); }
        }

        function importSave(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const req = indexedDB.open("wasmemu_db");
                req.onsuccess = () => {
                    const db = req.result;
                    const transaction = db.transaction("files", "readwrite");
                    transaction.objectStore("files").put({
                        contents: new Uint8Array(e.target.result),
                        timestamp: new Date()
                    }, "/home/web_user/.pcsx/memcards/card1.mcd");
                    alert("Save imported! Now select your .BIN game.");
                };
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
    </script>
</body>
</html>
